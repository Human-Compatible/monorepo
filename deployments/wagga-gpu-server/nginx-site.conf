upstream app_server {
  server unix:/home/simon/git/monorepo/server/run/gunicorn.sock fail_timeout=0;
}

map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

server {
  server_name api.home.assistance.chat;

  keepalive_timeout 5;
  client_max_body_size 4G;

  access_log /home/simon/.assistance/server/logs/nginx-access.log;
  error_log /home/simon/.assistance/server/logs/nginx-error.log;


  location / {

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_redirect off;
    proxy_buffering off;

    if (!-f $request_filename) {
      proxy_pass http://app_server;
      break;
    }
  }


  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}

server {
  server_name api.refuge.au;

  keepalive_timeout 5;
  client_max_body_size 4G;

  access_log /home/simon/.assistance/server/logs/nginx-access.log;
  error_log /home/simon/.assistance/server/logs/nginx-error.log;


  location / {

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_redirect off;
    proxy_buffering off;

    if (!-f $request_filename) {
      proxy_pass http://app_server;
      break;
    }
  }


  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}


server {
  server_name crm.assistance.chat;
  root /var/www/crm/public;

  access_log /home/simon/.assistance/server/logs/crm-nginx-access.log;
  error_log /home/simon/.assistance/server/logs/crm-nginx-error.log;

  index index.php index.html index.htm index.nginx-debian.html;

  location / {
    try_files $uri $uri/ /index.php?$query_string;
  }

  location /legacy/ {
    try_files $uri $uri/ /legacy/index.php?$query_string;
  }

  location ~ \.php$ {
    include snippets/fastcgi-php.conf;
    fastcgi_pass unix:/run/php/php8.1-fpm.sock;
  }

  location ~ /\.ht {
    deny all;
  }

  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}


server {
  server_name logs.phirho.assistance.chat;

  auth_basic "Phi Rho Logs";
  auth_basic_user_file /etc/apache2/.phirho-htpasswd;

  access_log /home/simon/.assistance/server/logs/phirho/nginx/access-to-this-file-server.log;
  error_log /home/simon/.assistance/server/logs/phirho/nginx/errors-on-this-file-server.log;


  autoindex on; # enable directory listing output
  autoindex_exact_size off; # output file sizes rounded to kilobytes, megabytes, and gigabytes
  autoindex_localtime on; # output local times in the directory

  location / {
    add_header Cache-Control 'no-store';
    add_header Cache-Control 'no-cache';
    expires 0;
    add_header Content-disposition "inline";

    root /home/simon/.assistance/server/logs/phirho;

  }


  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}

server {

  server_name admin.home.assistance.chat;

  auth_basic "Admin Streamlit App";
  auth_basic_user_file /etc/apache2/.htpasswd;

  location / {
    proxy_pass http://127.0.0.1:8501;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 86400;
  }

  client_max_body_size 100M;


  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}


map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}


upstream grafana {
  server localhost:5452;
}


server {

  server_name grafana.refuge.au;

  # auth_basic "Grafana Dashboard";
  # auth_basic_user_file /etc/apache2/.htpasswd;

  location / {
    proxy_pass http://grafana;
    proxy_set_header Host $host;
  }

  location /api/live/ {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host $http_host;
    proxy_pass http://grafana;
  }


  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}


server {
  server_name cal.assistance.chat cal.refuge.au cal.humancompatible.co;

  location ~ ^/simonbiggs/(.*) {
    rewrite ^/simonbiggs/(.*)$ https://cal.humancompatible.co/simon/$1 last;
  }

  location / {
    proxy_pass http://127.0.0.1:3431;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 86400;
  }

  client_max_body_size 100M;

  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}

server {

  server_name affine.refuge.au;

  location / {
    proxy_pass http://127.0.0.1:8080;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 86400;
  }

  client_max_body_size 100M;


  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}

server {

  server_name invoke.refuge.au;

  location / {
    proxy_pass http://127.0.0.1:9090;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 86400;
  }

  client_max_body_size 100M;


  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}


server {

  server_name discourse.guildofentrepreneurs.com;

  location / {
    proxy_pass http://127.0.0.1:8008;
    proxy_set_header Host $http_host;
    proxy_http_version 1.1;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;
    # Disable default "Connection: close"
    proxy_set_header "Connection" "";

  }


  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}

server {

  server_name community.thegreenhouse.digital;

  location / {
    proxy_pass http://127.0.0.1:8008;
    proxy_set_header Host $http_host;
    proxy_http_version 1.1;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;
    # Disable default "Connection: close"
    proxy_set_header "Connection" "";

  }


  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}

server {

  server_name community.internationalstudentassistance.com;

  location / {
    proxy_pass http://127.0.0.1:8008;
    proxy_set_header Host $http_host;
    proxy_http_version 1.1;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;
    # Disable default "Connection: close"
    proxy_set_header "Connection" "";

  }


  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}

server {

  server_name c.internationalstudentassistance.com;

  location / {
    proxy_pass http://127.0.0.1:8008;
    proxy_set_header Host $http_host;
    proxy_http_version 1.1;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP $remote_addr;
    # Disable default "Connection: close"
    proxy_set_header "Connection" "";

  }


  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}


server {

  server_name refuge.au matrix.refuge.au element.refuge.au;

  location / {
    # note: do not add a path (even a single /) after the port in `proxy_pass`,
    # otherwise, nginx will canonicalise the URI and cause signature verification
    # errors.
    proxy_pass http://localhost:81;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;

    access_log /var/log/nginx/matrix.access.log;
    error_log /var/log/nginx/matrix.error.log;

    # Nginx by default only allows file uploads up to 1M in size
    # Increase client_max_body_size to match max_upload_size defined in homeserver.yaml
    client_max_body_size 50M;
  }


  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}

# settings for matrix federation
server {
  # For the federation port
  listen 8448 ssl http2 default_server;
  listen [::]:8448 ssl http2 default_server;

  server_name matrix.refuge.au;

  location / {
    proxy_pass http://localhost:8449;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Host $host;

    access_log /var/log/nginx/matrix.access.log;
    error_log /var/log/nginx/matrix.error.log;

    # Nginx by default only allows file uploads up to 1M in size
    # Increase client_max_body_size to match max_upload_size defined in homeserver.yaml
    client_max_body_size 50M;
  }

  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}

server {
  server_name prose.guildofentrepreneurs.com;

  location / {
    proxy_pass http://localhost:8929;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
  }


  listen 443 ssl; # managed by Certbot
  ssl_certificate /etc/letsencrypt/live/admin.home.assistance.chat/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/admin.home.assistance.chat/privkey.pem; # managed by Certbot
  include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}


server {
  if ($host = admin.home.assistance.chat) {
    return 301 https://$host$request_uri;
    } # managed by Certbot


    server_name admin.home.assistance.chat;
    listen 80;
    return 404; # managed by Certbot


  }

  server {
    if ($host = api.home.assistance.chat) {
      return 301 https://$host$request_uri;
      } # managed by Certbot


      server_name api.home.assistance.chat;
      listen 80;
      return 404; # managed by Certbot


    }

    server {
      if ($host = logs.phirho.assistance.chat) {
        return 301 https://$host$request_uri;
        } # managed by Certbot


        server_name logs.phirho.assistance.chat;
        listen 80;
        return 404; # managed by Certbot


      }


      server {
        if ($host = cal.assistance.chat) {
          return 301 https://$host$request_uri;
          } # managed by Certbot


          server_name cal.assistance.chat;
          listen 80;
          return 404; # managed by Certbot


        }


        server {
          if ($host = crm.assistance.chat) {
            return 301 https://$host$request_uri;
            } # managed by Certbot


            server_name crm.assistance.chat;
            listen 80;
            return 404; # managed by Certbot


          }


          server {
            if ($host = discourse.guildofentrepreneurs.com) {
              return 301 https://$host$request_uri;
              } # managed by Certbot


              server_name discourse.guildofentrepreneurs.com;
              listen 80;
              return 404; # managed by Certbot


            }


            server {
              if ($host = api.refuge.au) {
                return 301 https://$host$request_uri;
                } # managed by Certbot


                server_name api.refuge.au;
                listen 80;
                return 404; # managed by Certbot


              }


              server {
                if ($host = community.thegreenhouse.digital) {
                  return 301 https://$host$request_uri;
                  } # managed by Certbot


                  server_name community.thegreenhouse.digital;
                  listen 80;
                  return 404; # managed by Certbot


                }


                server {
                  if ($host = community.internationalstudentassistance.com) {
                    return 301 https://$host$request_uri;
                    } # managed by Certbot


                    server_name community.internationalstudentassistance.com;
                    listen 80;
                    return 404; # managed by Certbot


                  }


                  server {
                    if ($host = c.internationalstudentassistance.com) {
                      return 301 https://$host$request_uri;
                      } # managed by Certbot


                      server_name c.internationalstudentassistance.com;
                      listen 80;
                      return 404; # managed by Certbot


                    }


                    server {
                      if ($host = matrix.refuge.au) {
                        return 301 https://$host$request_uri;
                        } # managed by Certbot


                        if ($host = element.refuge.au) {
                          return 301 https://$host$request_uri;
                          } # managed by Certbot


                          if ($host = refuge.au) {
                            return 301 https://$host$request_uri;
                            } # managed by Certbot


                            server_name refuge.au matrix.refuge.au element.refuge.au;
                            listen 80;
                            return 404; # managed by Certbot


                          }


                          server {
                            if ($host = prose.guildofentrepreneurs.com) {
                              return 301 https://$host$request_uri;
                              } # managed by Certbot


                              server_name prose.guildofentrepreneurs.com;
                              listen 80;
                              return 404; # managed by Certbot


                            }


                            server {
                              if ($host = affine.refuge.au) {
                                return 301 https://$host$request_uri;
                                } # managed by Certbot


                                server_name affine.refuge.au;
                                listen 80;
                                return 404; # managed by Certbot


                              }


                              server {
                                if ($host = grafana.refuge.au) {
                                  return 301 https://$host$request_uri;
                                  } # managed by Certbot


                                  server_name grafana.refuge.au;
                                  listen 80;
                                  return 404; # managed by Certbot


                                }


                                server {
                                  if ($host = invoke.refuge.au) {
                                    return 301 https://$host$request_uri;
                                    } # managed by Certbot


                                    server_name invoke.refuge.au;
                                    listen 80;
                                    return 404; # managed by Certbot


                                  }
